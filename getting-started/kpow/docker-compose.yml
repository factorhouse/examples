# Kpow Quick Start with OSS Kafka
# This docker-compose spins up Kpow connected to a local Kafka cluster
#
# Get started: docker compose up -d
# Access Kpow at: http://localhost:3000
#
####################################################################################################
# DO NOT USE IN PRODUCTION
#
# This is a getting-started configuration. For production deployments, please see:
# https://docs.factorhouse.io/kpow/installation/
####################################################################################################

services:
  # Kpow Enterprise Edition - Kafka monitoring and management UI
  # https://docs.factorhouse.io/kpow/
  kpow:
    image: factorhouse/kpow:latest
    container_name: kpow
    ports:
      - "3000:3000"
    networks:
      - kpow-network
    profiles:
      - trial
    environment:
      # Environment name (displayed in Kpow UI)
      ENVIRONMENT_NAME: "Welcome to Kpow"

      # You can replace the following with the boostrap URL of your own Kafka cluster.
      BOOTSTRAP: "broker:29092"

      # Your license details. Don't share these!
      LICENSE_ID: "<LICENSE_ID>"
      LICENSE_CODE: "<LICENSE_CODE>"
      LICENSEE: "<LICENSEE>"
      LICENSE_EXPIRY: "<LICENSE_EXPIRY>"
      LICENSE_SIGNATURE: "<LICENSE_SIGNATURE>"

      # General configurations
      INFER_TOPIC_SERDES: "true"
      REPLICATION_FACTOR: "1"
      NUM_PARTITIONS: "1"

      # Feature flags via Simple Access Control. See the full list of flags at https://docs.factorhouse.io/kpow/authorization/simple-access-control
      ALLOW_KPOW_ADMIN: "true" # Allow users to admin panels and controls
      ALLOW_TOPIC_INSPECT: "true" # Allow users to read topic key and value data
      ALLOW_TOPIC_PRODUCE: "true" # Allow users to write new messages to topics
      ALLOW_TOPIC_CREATE: "true" # Allow users to create new topics
      ALLOW_TOPIC_EDIT: "true" # Allow users to edit topic configuration
      ALLOW_TOPIC_DELETE: "true" # Allow users to delete topics
      ALLOW_TOPIC_TRUNCATE: "true" # Allow users to truncate topics
      ALLOW_TOPIC_ELECT_LEADER: "true" # Allow users to elect the leader replica of a topic partition
      ALLOW_TOPIC_ALTER_REASSIGNMENTS: "true" # Allow users to edit the reassignments of a topic partition
      ALLOW_GROUP_EDIT: "true" # Allow users to change consumer group offsets
      ALLOW_GROUP_DELETE: "true" # Allow users to delete consumer groups entirely
      ALLOW_BROKER_EDIT: "true" # Allow users to edit broker configuration
      ALLOW_ACL_EDIT: "true" # Allow users to create and delete Kafka ACLs
      ALLOW_QUOTA_EDIT: "true" # Allow users to create, edit and delete Kafka Quotas
      ALLOW_BULK_ACTION: "true" # Allow users to invoke bulk actions

    depends_on:
      broker:
        condition: service_healthy
    mem_limit: 2g
    restart: unless-stopped
  # Kpow Community Edition - Kafka monitoring and management UI
  # https://docs.factorhouse.io/kpow/
  kpow-ce:
    image: factorhouse/kpow-ce:latest
    container_name: kpow-ce
    ports:
      - "3000:3000"
    networks:
      - kpow-network
    profiles:
      - community
    environment:
      # Environment name (displayed in Kpow UI)
      ENVIRONMENT_NAME: "Welcome to Kpow"

      # You can replace the following with the boostrap URL of your own Kafka cluster.
      BOOTSTRAP: "broker:29092"

      # Your license details. Don't share these!
      LICENSE_ID: "<LICENSE_ID>"
      LICENSE_CODE: "<LICENSE_CODE>"
      LICENSEE: "<LICENSEE>"
      LICENSE_EXPIRY: "<LICENSE_EXPIRY>"
      LICENSE_SIGNATURE: "<LICENSE_SIGNATURE>"
    depends_on:
      broker:
        condition: service_healthy
    mem_limit: 2g
    restart: unless-stopped

  # Apache Kafka in KRaft Mode
  broker:
    image: apache/kafka:4.1.1
    container_name: broker
    ports:
      - "9092:9092"
    networks:
      - kpow-network
    profiles:
      - trial
      - community
    environment:
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@broker:9093"
      KAFKA_LISTENERS: "PLAINTEXT://broker:29092,CONTROLLER://broker:9093,PLAINTEXT_HOST://0.0.0.0:9092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Kafka Producer
  producer:
    image: apache/kafka:4.1.1
    container_name: producer
    depends_on:
      broker:
        condition: service_healthy
    networks:
      - kpow-network
    profiles:
      - trial
      - community
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        # Wait a few seconds for the broker to be fully ready after healthcheck
        sleep 5

        echo "Creating topic 'getting-started'..."
        /opt/kafka/bin/kafka-topics.sh --create --topic getting-started --bootstrap-server broker:29092 --partitions 1 --replication-factor 1
        echo "Topic created."

        id=0
        echo "Starting to produce messages..."
        while true; do
          id=$$(($$id+1))
          
          random_string=$$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)

          message=$$(printf '{"id": %d, "message": "%s"}' "$$id" "$$random_string")
          
          echo "$$message" | /opt/kafka/bin/kafka-console-producer.sh --topic getting-started --bootstrap-server broker:29092
          
          echo "Produced: $$message"
          
          sleep 1
        done

networks:
  kpow-network:
    name: kpow-network
    driver: bridge
